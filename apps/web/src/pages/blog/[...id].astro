---
import { getCollection, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import BlogTags from '../../components/blog/BlogTags.astro';
import BlogCard from '../../components/blog/BlogCard.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft);

  return posts.map((post) => ({
    params: { id: post.id },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);

const { title, description, publishedAt, updatedAt, tags, coverImage } = post.data;

// Format dates
const formattedDate = publishedAt.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const formattedUpdateDate = updatedAt?.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Calculate reading time
function calculateReadingTime(content: string): number {
  const wordsPerMinute = 200;
  const words = content.split(/\s+/).length;
  return Math.ceil(words / wordsPerMinute);
}

const readingTime = calculateReadingTime(post.body || '');

// Get related posts (same tags, excluding current)
const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const relatedPosts = allPosts
  .filter((p) => p.id !== post.id)
  .filter((p) => p.data.tags.some((tag) => tags.includes(tag)))
  .sort((a, b) => b.data.publishedAt.valueOf() - a.data.publishedAt.valueOf())
  .slice(0, 2);
---

<BaseLayout title={`${title} â€“ Noah Kellner`} description={description}>
  <article class="section">
    <div class="container">
      <!-- Back Link -->
      <a
        href="/blog"
        class="inline-flex items-center gap-2 text-text-secondary hover:text-accent transition-colors mb-8"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back to Blog
      </a>

      <!-- Hero Section -->
      <header class="mb-12 max-w-3xl">
        <!-- Meta Info -->
        <div class="flex flex-wrap items-center gap-3 text-sm text-text-tertiary mb-4">
          <span class="flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            {formattedDate}
          </span>
          <span class="text-border">|</span>
          <span class="flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            {readingTime} min read
          </span>
          {formattedUpdateDate && (
            <>
              <span class="text-border">|</span>
              <span>Updated {formattedUpdateDate}</span>
            </>
          )}
        </div>

        <!-- Title -->
        <h1 class="text-4xl md:text-5xl font-display font-bold mb-6">
          {title}
        </h1>

        <!-- Description -->
        <p class="text-xl text-text-secondary mb-6">
          {description}
        </p>

        <!-- Tags -->
        <BlogTags tags={tags} size="md" />
      </header>

      <!-- Cover Image -->
      {coverImage ? (
        <div class="aspect-video rounded-xl overflow-hidden mb-12 border border-border">
          <img
            src={coverImage}
            alt={title}
            class="w-full h-full object-cover"
          />
        </div>
      ) : (
        <div class="aspect-video bg-bg-secondary rounded-xl mb-12 flex items-center justify-center border border-border">
          <div class="text-center text-text-tertiary">
            <svg class="w-16 h-16 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
            </svg>
          </div>
        </div>
      )}

      <!-- Content -->
      <div class="prose prose-invert max-w-3xl mx-auto">
        <Content />
      </div>

      <!-- Share Section -->
      <div class="max-w-3xl mx-auto mt-12 pt-8 border-t border-border">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <span class="text-sm text-text-tertiary">Share this article</span>
          <div class="flex gap-3">
            <a
              href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(`https://noah-kellner.de/blog/${post.id}`)}`}
              target="_blank"
              rel="noopener noreferrer"
              class="w-10 h-10 flex items-center justify-center rounded-lg bg-bg-secondary border border-border text-text-tertiary hover:text-accent hover:border-accent transition-colors"
              aria-label="Share on Twitter"
            >
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
              </svg>
            </a>
            <a
              href={`https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(`https://noah-kellner.de/blog/${post.id}`)}&title=${encodeURIComponent(title)}`}
              target="_blank"
              rel="noopener noreferrer"
              class="w-10 h-10 flex items-center justify-center rounded-lg bg-bg-secondary border border-border text-text-tertiary hover:text-accent hover:border-accent transition-colors"
              aria-label="Share on LinkedIn"
            >
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
              </svg>
            </a>
          </div>
        </div>
      </div>

      <!-- Related Posts -->
      {relatedPosts.length > 0 && (
        <section class="mt-16 pt-12 border-t border-border">
          <h2 class="text-2xl font-display font-bold mb-8">Related Posts</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {relatedPosts.map((relatedPost) => (
              <BlogCard
                post={relatedPost}
                readingTime={calculateReadingTime(relatedPost.body || '')}
              />
            ))}
          </div>
        </section>
      )}

      <!-- Navigation -->
      <nav class="mt-16 pt-8 border-t border-border">
        <a
          href="/blog"
          class="inline-flex items-center gap-2 text-accent hover:text-accent-hover transition-colors"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Back to all Posts
        </a>
      </nav>
    </div>
  </article>
</BaseLayout>

<style is:global>
  .prose {
    color: var(--color-text-secondary);
  }

  .prose h2 {
    color: var(--color-text-primary);
    font-family: var(--font-display);
    font-size: 1.75rem;
    font-weight: 600;
    margin-top: 3rem;
    margin-bottom: 1rem;
  }

  .prose h3 {
    color: var(--color-text-primary);
    font-family: var(--font-display);
    font-size: 1.25rem;
    font-weight: 600;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
  }

  .prose p {
    font-family: var(--font-body);
    line-height: 1.8;
    margin-bottom: 1.5rem;
    font-size: 1.0625rem;
  }

  .prose ul, .prose ol {
    margin-bottom: 1.5rem;
    padding-left: 1.5rem;
  }

  .prose li {
    margin-bottom: 0.5rem;
    line-height: 1.7;
  }

  .prose strong {
    color: var(--color-text-primary);
    font-weight: 600;
  }

  .prose a {
    color: var(--color-accent);
    text-decoration: underline;
    text-underline-offset: 3px;
    transition: color 0.2s;
  }

  .prose a:hover {
    color: var(--color-accent-hover);
  }

  .prose code {
    font-family: var(--font-mono);
    font-size: 0.875em;
    background-color: var(--color-bg-tertiary);
    padding: 0.2em 0.4em;
    border-radius: 0.25rem;
    color: var(--color-accent);
  }

  .prose pre {
    background-color: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 0.75rem;
    padding: 1.25rem;
    overflow-x: auto;
    margin-bottom: 1.5rem;
  }

  .prose pre code {
    background: none;
    padding: 0;
    font-size: 0.875rem;
    color: var(--color-text-secondary);
  }

  .prose blockquote {
    border-left: 3px solid var(--color-accent);
    padding-left: 1.25rem;
    margin-left: 0;
    margin-right: 0;
    font-style: italic;
    color: var(--color-text-tertiary);
  }

  .prose img {
    border-radius: 0.75rem;
    margin: 2rem 0;
  }

  .prose hr {
    border: none;
    border-top: 1px solid var(--color-border);
    margin: 3rem 0;
  }
</style>
