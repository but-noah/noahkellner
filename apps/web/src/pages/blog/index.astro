---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import BlogCard from '../../components/blog/BlogCard.astro';
import NewsletterSignup from '../../components/blog/NewsletterSignup.astro';

// Get all blog posts, filter out drafts
const allPosts = await getCollection('blog', ({ data }) => !data.draft);

// Sort by date (newest first)
const sortedPosts = allPosts.sort(
  (a, b) => b.data.publishedAt.valueOf() - a.data.publishedAt.valueOf()
);

// Extract all unique tags
const allTags = [...new Set(sortedPosts.flatMap((post) => post.data.tags))].sort();

// Calculate reading time for each post
function calculateReadingTime(content: string): number {
  const wordsPerMinute = 200;
  const words = content.split(/\s+/).length;
  return Math.ceil(words / wordsPerMinute);
}
---

<BaseLayout
  title="Blog â€“ Noah Kellner"
  description="Thoughts on AI, infrastructure, leadership, and building technology that matters."
>
  <section class="section">
    <div class="container">
      <!-- Header -->
      <div class="max-w-3xl mb-8">
        <p class="text-accent text-sm font-sans uppercase tracking-wider mb-4">Blog</p>
        <h1 class="text-4xl md:text-5xl font-display font-bold mb-4">
          Thoughts & Insights
        </h1>
        <p class="text-lg text-text-secondary">
          Exploring AI, infrastructure, and the art of building technology that makes a difference.
          Lessons learned, ideas explored, and experiences shared.
        </p>
      </div>

      <!-- Tag Filter -->
      {allTags.length > 0 && (
        <div class="mb-10">
          <div class="flex flex-wrap items-center gap-2">
            <span class="text-sm text-text-tertiary mr-2">Filter:</span>
            <button
              data-tag="all"
              class="tag-filter active px-3 py-1.5 text-sm font-sans rounded-lg transition-all duration-200"
            >
              All Posts
            </button>
            {allTags.map((tag) => (
              <button
                data-tag={tag}
                class="tag-filter px-3 py-1.5 text-sm font-sans rounded-lg transition-all duration-200"
              >
                {tag}
              </button>
            ))}
          </div>
        </div>
      )}

      <!-- Posts Grid -->
      {sortedPosts.length > 0 ? (
        <div id="posts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {sortedPosts.map((post) => (
            <div class="blog-post-item" data-tags={JSON.stringify(post.data.tags)}>
              <BlogCard
                post={post}
                readingTime={calculateReadingTime(post.body || '')}
              />
            </div>
          ))}
        </div>
      ) : (
        <!-- Empty State -->
        <div class="text-center py-20">
          <div class="w-16 h-16 bg-bg-secondary rounded-full flex items-center justify-center mx-auto mb-6">
            <svg class="w-8 h-8 text-text-tertiary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
            </svg>
          </div>
          <h2 class="text-xl font-display font-semibold mb-2">Coming Soon</h2>
          <p class="text-text-tertiary max-w-md mx-auto">
            I'm working on some interesting articles. Check back soon for thoughts on AI, infrastructure, and technology leadership.
          </p>
        </div>
      )}

      <!-- No Results State (hidden by default) -->
      <div id="no-results" class="hidden text-center py-16">
        <div class="w-14 h-14 bg-bg-secondary rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-7 h-7 text-text-tertiary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
        <h3 class="text-lg font-display font-semibold mb-2">No posts found</h3>
        <p class="text-text-tertiary text-sm">
          No articles match this filter. Try selecting a different tag.
        </p>
      </div>
    </div>
  </section>

  <!-- Newsletter Signup -->
  <NewsletterSignup />
</BaseLayout>

<style>
  .tag-filter {
    background: var(--color-bg-secondary);
    color: var(--color-text-tertiary);
    border: 1px solid var(--color-border);
  }

  .tag-filter:hover {
    border-color: var(--color-accent);
    color: var(--color-text-secondary);
  }

  .tag-filter.active {
    background: var(--color-accent);
    color: var(--color-bg-primary);
    border-color: var(--color-accent);
  }

  .blog-post-item {
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  .blog-post-item.hidden {
    display: none;
  }

  .blog-post-item.fade-out {
    opacity: 0;
    transform: scale(0.95);
  }
</style>

<script>
  function initTagFilter() {
    const filterButtons = document.querySelectorAll('.tag-filter');
    const postItems = document.querySelectorAll('.blog-post-item');
    const noResults = document.getElementById('no-results');
    const postsGrid = document.getElementById('posts-grid');

    filterButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const selectedTag = button.getAttribute('data-tag');

        // Update active state
        filterButtons.forEach((btn) => btn.classList.remove('active'));
        button.classList.add('active');

        // Filter posts with animation
        let visibleCount = 0;

        postItems.forEach((item) => {
          const itemTags = JSON.parse(item.getAttribute('data-tags') || '[]');
          const shouldShow = selectedTag === 'all' || itemTags.includes(selectedTag);

          if (shouldShow) {
            item.classList.remove('hidden', 'fade-out');
            visibleCount++;
          } else {
            item.classList.add('fade-out');
            setTimeout(() => {
              item.classList.add('hidden');
            }, 200);
          }
        });

        // Show/hide no results message
        setTimeout(() => {
          if (visibleCount === 0) {
            postsGrid?.classList.add('hidden');
            noResults?.classList.remove('hidden');
          } else {
            postsGrid?.classList.remove('hidden');
            noResults?.classList.add('hidden');
          }
        }, 250);
      });
    });
  }

  // Run on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTagFilter);
  } else {
    initTagFilter();
  }

  // Run on Astro page navigation
  document.addEventListener('astro:page-load', initTagFilter);
</script>
